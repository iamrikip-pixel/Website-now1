# app.py
# Your Local Service â€” single-file Flask app (Pydroid-compatible)
# Features:
# - Beautiful UI (auto-creates templates/ and static/)
# - Providers list, details, booking (saved)
# - Feedback form in footer (saved, admin-only view)
# - Admin panel (add/delete providers, view bookings & feedback)
# - Pop click sound generated by WebAudio and animations
# Run: python app.py

import os
from datetime import datetime
from flask import Flask, render_template, request, redirect, url_for, flash, session
from flask_sqlalchemy import SQLAlchemy

APP_DIR = os.path.dirname(os.path.abspath(__file__))
TEMPLATES_DIR = os.path.join(APP_DIR, "templates")
STATIC_DIR = os.path.join(APP_DIR, "static")

def ensure_files():
    os.makedirs(TEMPLATES_DIR, exist_ok=True)
    os.makedirs(STATIC_DIR, exist_ok=True)

    # CSS
    css_path = os.path.join(STATIC_DIR, "style.css")
    if not os.path.exists(css_path):
        with open(css_path, "w", encoding="utf-8") as f:
            f.write(r"""
/* style.css - Your Local Service polished UI */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
:root{
  --bg:#f5f8fb; --card:#ffffff; --text:#0b2136; --muted:#6b7280;
  --accent:#0077ff; --accent-2:#005ec3; --glass: rgba(0,119,255,0.06);
}
*{box-sizing:border-box}
body{font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);margin:0}
.navbar{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:12px 18px;color:#fff;display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 28px rgba(0,94,195,0.08)}
.brand{font-weight:700;font-size:18px;display:flex;flex-direction:column}
.domain{font-size:12px;opacity:.95;color:rgba(255,255,255,0.92);font-weight:600}
.navbar nav a{color:rgba(255,255,255,0.95);text-decoration:none;margin-left:14px;font-weight:600}
.container{max-width:1150px;margin:22px auto;padding:0 16px}
.header-card{background:transparent;padding:10px 0}
.search-card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 10px 40px rgba(7,20,40,0.03);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.form-control, .form-select, textarea{border:1px solid #e6eef7;padding:10px;border-radius:10px;font-size:14px}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;outline:none;transform:translateZ(0)}
button.primary:hover{filter:brightness(1.03);box-shadow:0 12px 30px rgba(0,94,195,0.12);transform:translateY(-2px)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;margin-top:18px}
.card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 14px 40px rgba(7,20,40,0.04);transition:transform .18s ease, box-shadow .18s ease, opacity .4s ease;opacity:0;transform:translateY(8px)}
.card.visible{opacity:1;transform:none}
.card:hover{transform:translateY(-6px);box-shadow:0 20px 48px rgba(7,20,40,0.08)}
.title{font-weight:700;font-size:16px}
.meta{color:var(--muted);font-size:13px;margin-top:6px}
.action-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.badge{background:var(--glass);color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
.footer{margin-top:34px;padding:18px;text-align:center;color:var(--muted);font-size:14px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02));}
.ripple{position:relative;overflow:hidden}
.ripple:after{content:"";display:block;position:absolute;width:100px;height:100px;top:var(--y);left:var(--x);pointer-events:none;background:rgba(255,255,255,0.22);transform:translate(-50%,-50%) scale(0);border-radius:50%;transition:transform .6s ease-out,opacity .6s}
.ripple:active:after{transform:translate(-50%,-50%) scale(2.4);opacity:0;transition:0s}
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;animation:fadeIn .15s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--card);padding:18px;border-radius:12px;max-width:520px;width:100%}
.btn-click-animate{animation:btnPop .12s ease}
@keyframes btnPop{0%{transform:scale(1)}50%{transform:scale(0.96)}100%{transform:scale(1)}}
.footer .feedback {max-width:1000px;margin:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.footer input, .footer textarea{padding:10px;border-radius:8px;border:1px solid #e6eef7}
@media(max-width:560px){.search-card{flex-direction:column;align-items:stretch}.action-row{flex-direction:column;gap:8px}.footer .feedback{flex-direction:column;align-items:stretch}}
""")

    # base.html
    base_path = os.path.join(TEMPLATES_DIR, "base.html")
    if not os.path.exists(base_path):
        with open(base_path, "w", encoding="utf-8") as f:
            f.write("""<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Your Local Service â€” Built by Rikip</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2099/2099058.png">
</head><body>
  <header class="navbar">
    <div class="brand">
      <div style="display:flex;gap:10px;align-items:center"><div style="font-size:18px">ðŸ”§ Your Local Service</div><div class="domain">www.yourlocalservice.com</div></div>
    </div>
    <nav>
      <a class="click-sound" href="{{ url_for('home') }}">Home</a>
      <a class="click-sound" href="{{ url_for('about') }}">About</a>
      <a class="click-sound" href="{{ url_for('contact_page') }}">Contact</a>
      {% if session.get('admin') %}
        <a class="click-sound" href="{{ url_for('admin') }}">Admin</a>
        <a class="click-sound" href="{{ url_for('admin_logout') }}">Logout</a>
      {% else %}
        <a class="click-sound" href="{{ url_for('admin_login') }}">Admin Login</a>
      {% endif %}
    </nav>
  </header>

  <main class="container" style="min-height:60vh">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div style="margin-top:12px">
        {% for m in messages %}
          <div class="alert alert-info">{{ m }}</div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <footer class="footer">
    <div style="padding-bottom:8px">
      <strong>Contact:</strong> iamrikip22llb@gmail.com â€¢ 7810804100
    </div>

    <div class="feedback" style="margin-top:12px">
      <form method="post" action="{{ url_for('feedback') }}" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center">
        <input name="name" placeholder="Your name" class="form-control" style="max-width:220px" required>
        <input name="email" placeholder="Email" class="form-control" style="max-width:260px" required>
        <textarea name="message" placeholder="Message / feedback" class="form-control" style="max-width:360px;min-height:48px" required></textarea>
        <button class="primary click-sound ripple">Send Feedback</button>
      </form>
    </div>

    <div style="margin-top:14px">Â© 2025 Your Local Service â€¢ Built by Rikip</div>
  </footer>

  <script>
  // WebAudio pop sound (no file needed)
  const AudioPlayer = (function(){
    let ctx = null;
    function init(){ if(ctx) return; try{ ctx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ ctx = null; } }
    function playPop(){ init(); if(!ctx) return; const o = ctx.createOscillator(), g = ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(800, ctx.currentTime); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.18); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.18); }
    return { playPop };
  })();

  function attachClickSounds(){
    const selectors = 'button, .btn, a.click-sound';
    document.querySelectorAll(selectors).forEach(el=>{
      if(el.__lc_attached) return;
      el.__lc_attached = true;
      el.addEventListener('pointerdown', function(e){
        this.style.setProperty('--x', (e.offsetX || e.clientX) + 'px');
        this.style.setProperty('--y', (e.offsetY || e.clientY) + 'px');
      });
      el.addEventListener('click', function(e){
        AudioPlayer.playPop();
        this.classList.remove('btn-click-animate'); void this.offsetWidth; this.classList.add('btn-click-animate');
      });
    });
  }

  function revealCards(){ const cards=document.querySelectorAll('.card'); cards.forEach((c,i)=>setTimeout(()=>c.classList.add('visible'),80*i)); }

  document.addEventListener('DOMContentLoaded', function(){ attachClickSounds(); revealCards(); });

  function showModal(html){ const el=document.createElement('div'); el.innerHTML='<div class="modal-backdrop" id="lcModal">'+html+'</div>'; document.body.appendChild(el); document.getElementById('lcModal').addEventListener('click', function(ev){ if(ev.target.id==='lcModal') this.remove(); }); }
  function closeModal(){ const m=document.getElementById('lcModal'); if(m) m.remove(); }
  </script>
</body></html>""")

    # index.html
    index_path = os.path.join(TEMPLATES_DIR, "index.html")
    if not os.path.exists(index_path):
        with open(index_path, "w", encoding="utf-8") as f:
            f.write("""{% extends "base.html" %}{% block content %}
<div class="header-card">
  <h1 style="margin:6px 0 2px 0">Find trusted local services</h1>
  <p class="meta">Plumbers â€¢ Electricians â€¢ Tutors â€¢ Mechanics â€¢ Cleaners â€” for small towns and neighborhoods</p>

  <div style="margin-top:12px" class="search-card">
    <form method="get" style="display:flex;gap:10px;align-items:center;flex:1;flex-wrap:wrap">
      <input name="q" placeholder="Search service or provider (e.g. plumber, Rohit)" class="form-control" value="{{ request.args.get('q','') }}">
      <input name="location" placeholder="Location (city/area)" class="form-control" style="max-width:240px" value="{{ request.args.get('location','') }}">
      <select name="service" class="form-select" style="max-width:220px">
        <option value="">All services</option>
        {% for s in services_list %}<option value="{{ s }}" {% if s==request.args.get('service') %}selected{% endif %}>{{ s.title() }}</option>{% endfor %}
      </select>
      <button class="primary click-sound ripple">Search</button>
    </form>
  </div>
</div>

<h4 style="margin-top:18px">Results</h4>
<div class="grid">
  {% for p in providers %}
  <div class="card">
    <div style="display:flex;gap:12px">
      <img src="{{ p.image_url }}" alt="{{ p.name }}" style="width:76px;height:76px;object-fit:cover;border-radius:10px">
      <div style="flex:1">
        <div class="title">{{ p.name }}</div>
        <div class="meta">{{ p.service }} â€¢ {{ p.location }}</div>
        <div class="meta" style="margin-top:8px">{{ p.description }}</div>
        <div class="action-row">
          <div><span class="badge">â‚¹{{ p.price }}</span> <span style="margin-left:10px;color:#ffb703;font-weight:700">â˜… {{ p.rating }}</span></div>
          <div>
            <a href="tel:{{ p.phone }}" class="btn btn-sm btn-outline-primary click-sound ripple">Call Now</a>
            <a href="{{ url_for('provider_detail', prov_id=p.id) }}" class="btn btn-sm btn-primary click-sound ripple">Details</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
    <div class="muted">No providers found.</div>
  {% endfor %}
</div>
{% endblock %}""")

    # provider_detail
    detail_path = os.path.join(TEMPLATES_DIR, "provider_detail.html")
    if not os.path.exists(detail_path):
        with open(detail_path, "w", encoding="utf-8") as f:
            f.write("""{% extends "base.html" %}{% block content %}
<div style="margin-top:18px" class="card">
  <div style="display:flex;gap:20px;align-items:flex-start">
    <img src="{{ provider.image_url }}" alt="{{ provider.name }}" style="width:150px;height:150px;object-fit:cover;border-radius:12px">
    <div>
      <h2 style="margin:0">{{ provider.name }}</h2>
      <div class="meta">{{ provider.service }} â€¢ {{ provider.location }}</div>
      <p style="margin-top:10px">{{ provider.description }}</p>
      <p><strong>Price:</strong> â‚¹{{ provider.price }} â€¢ <strong>Phone:</strong> <a class="click-sound" href="tel:{{ provider.phone }}">{{ provider.phone }}</a></p>
      <p><strong>Rating:</strong> â˜… {{ provider.rating }} ({{ provider.reviews_count }} reviews)</p>
    </div>
  </div>
</div>

<div class="card" style="margin-top:14px">
  <h5>Book this service</h5>
  <form method="post" action="{{ url_for('book', prov_id=provider.id) }}">
    <input name="name" placeholder="Your name" class="form-control" required>
    <input name="phone" placeholder="Phone number" class="form-control" required style="margin-top:8px">
    <textarea name="message" placeholder="Address / preferred time" class="form-control" rows="4" style="margin-top:8px"></textarea>
    <div style="margin-top:10px"><button class="primary click-sound ripple">Send Booking Request</button></div>
  </form>
</div>
{% endblock %}""")

    # about
    about_path = os.path.join(TEMPLATES_DIR, "about.html")
    if not os.path.exists(about_path):
        with open(about_path, "w", encoding="utf-8") as f:
            f.write("""{% extends "base.html" %}{% block content %}
<div class="card" style="margin-top:18px">
  <h2>About Your Local Service</h2>
  <p class="meta">Your Local Service by Rikip connects households with trusted local professionals in small towns. Clean UI, one-tap contact, and easy booking.</p>
  <ul>
    <li>Search by service or location</li>
    <li>One-tap call and booking</li>
    <li>Admin panel to manage providers, bookings and feedback</li>
  </ul>
</div>
{% endblock %}""")

    # contact page
    contact_path = os.path.join(TEMPLATES_DIR, "contact.html")
    if not os.path.exists(contact_path):
        with open(contact_path, "w", encoding="utf-8") as f:
            f.write("""{% extends "base.html" %}{% block content %}
<div class="card" style="margin-top:18px">
  <h3>Contact</h3>
  <p class="meta">Owner: <strong>Rikip</strong></p>
  <p class="meta">Email: iamrikip22llb@gmail.com</p>
  <p class="meta">Phone: 7810804100</p>
  <p style="margin-top:8px">Thanks for choosing Your Local Service.</p>
</div>
{% endblock %}""")

    # admin login & admin panel
    admin_login = os.path.join(TEMPLATES_DIR, "admin_login.html")
    if not os.path.exists(admin_login):
        with open(admin_login, "w", encoding="utf-8") as f:
            f.write("""{% extends "base.html" %}{% block content %}
<div style="max-width:480px;margin-top:20px">
  <div class="card">
    <h4>Admin Login</h4>
    <form method="post">
      <input name="email" placeholder="Admin username (admin)" class="form-control" required>
      <input name="password" placeholder="Password" type="password" class="form-control" required style="margin-top:8px">
      <div style="margin-top:8px"><button class="primary click-sound ripple">Login</button></div>
    </form>
  </div>
</div>
{% endblock %}""")

    admin_panel = os.path.join(TEMPLATES_DIR, "admin_panel.html")
    if not os.path.exists(admin_panel):
        with open(admin_panel, "w", encoding="utf-8") as f:
            f.write("""{% extends "base.html" %}{% block content %}
<div class="card" style="margin-top:18px">
  <h4>Admin Panel</h4>
  <p class="meta">Add / remove providers and view bookings & feedback</p>

  <form method="post" action="{{ url_for('admin_add') }}" class="search-card" style="margin-bottom:12px">
    <input name="name" placeholder="Name" class="form-control" style="max-width:260px" required>
    <input name="service" placeholder="Service" class="form-control" style="max-width:220px" required>
    <input name="location" placeholder="Location" class="form-control" style="max-width:220px" required>
    <input name="phone" placeholder="Phone" class="form-control" style="max-width:180px" required>
    <input name="price" placeholder="Price" class="form-control" style="max-width:140px">
    <input name="image_url" placeholder="Image URL" class="form-control" style="max-width:320px">
    <button class="primary click-sound ripple">Add Provider</button>
  </form>

  <hr>
  <h5>Providers</h5>
  {% for p in providers %}
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0">
      <div><b>{{ p.name }}</b> â€” {{ p.service }} â€¢ {{ p.location }}</div>
      <div><a href="{{ url_for('admin_delete', prov_id=p.id) }}" class="btn btn-sm btn-outline-danger click-sound ripple">Delete</a></div>
    </div>
  {% else %}
    <p class="muted">No providers.</p>
  {% endfor %}

  <hr>
  <h5>Bookings</h5>
  {% for b in bookings %}
    <div style="padding:8px 0;border-bottom:1px solid #f0f0f0">
      <div><b>{{ b.name }}</b> requested <em>{{ b.provider.name }}</em> â€” {{ b.phone }} <span class="meta" style="margin-left:8px">on {{ b.created_at.strftime('%Y-%m-%d %H:%M') }}</span></div>
      <div class="meta">{{ b.message }}</div>
    </div>
  {% else %}
    <p class="muted">No bookings yet.</p>
  {% endfor %}

  <hr>
  <h5>Feedback (User messages)</h5>
  {% for fb in feedbacks %}
    <div style="padding:8px 0;border-bottom:1px solid #f0f0f0">
      <div><b>{{ fb.name }}</b> â€” {{ fb.email }} <span class="meta" style="margin-left:8px">on {{ fb.created_at.strftime('%Y-%m-%d %H:%M') }}</span></div>
      <div class="meta">{{ fb.message }}</div>
    </div>
  {% else %}
    <p class="muted">No feedback yet.</p>
  {% endfor %}
</div>
{% endblock %}""")

ensure_files()

# -------------------------
# Flask + DB config
# -------------------------
app = Flask(__name__, template_folder=TEMPLATES_DIR, static_folder=STATIC_DIR)
app.config['SECRET_KEY'] = os.environ.get('LC_SECRET', 'yourlocalservice-secret')
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(APP_DIR, 'yourlocalservice.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# -------------------------
# Models
# -------------------------
class Provider(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(140), nullable=False)
    service = db.Column(db.String(80), nullable=False)
    location = db.Column(db.String(140), nullable=False)
    phone = db.Column(db.String(40), nullable=False)
    price = db.Column(db.String(80), nullable=True)
    image_url = db.Column(db.String(400), nullable=True)
    description = db.Column(db.Text, nullable=True)
    rating = db.Column(db.Float, default=4.7)
    reviews_count = db.Column(db.Integer, default=5)

class Booking(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(140), nullable=False)
    phone = db.Column(db.String(40), nullable=False)
    message = db.Column(db.Text, nullable=True)
    provider_id = db.Column(db.Integer, db.ForeignKey('provider.id'), nullable=False)
    created_at = db.Column(db.DateTime, server_default=db.func.now())
    provider = db.relationship('Provider')

class Feedback(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(140), nullable=False)
    email = db.Column(db.String(200), nullable=False)
    message = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, server_default=db.func.now())

# -------------------------
# Seed demo data
# -------------------------
with app.app_context():
    db.create_all()
    if Provider.query.count() == 0:
        demo = [
            {"name":"Rohit Sharma","service":"Electrician","location":"Cooch Behar","phone":"+919876543210","price":"300","image_url":"https://cdn-icons-png.flaticon.com/512/2965/2965879.png","description":"Experienced home electrician."},
            {"name":"Anjali Das","service":"Home Tutor","location":"Jalpaiguri","phone":"+919123456780","price":"500","image_url":"https://cdn-icons-png.flaticon.com/512/3135/3135789.png","description":"Math & Science tutor."},
            {"name":"Ramesh Roy","service":"Plumber","location":"Siliguri","phone":"+919988776655","price":"250","image_url":"https://cdn-icons-png.flaticon.com/512/8099/8099546.png","description":"Pipe & leakage specialist."},
            {"name":"Tania Paul","service":"Beautician","location":"Cooch Behar","phone":"+919001234567","price":"800","image_url":"https://cdn-icons-png.flaticon.com/512/706/706830.png","description":"Home-visit beautician."},
            {"name":"Amit Dey","service":"AC Mechanic","location":"Jalpaiguri","phone":"+919812345670","price":"600","image_url":"https://cdn-icons-png.flaticon.com/512/2995/2995579.png","description":"AC repair & gas refill."},
            {"name":"Nisha Kapoor","service":"Beautician","location":"Jalpaiguri","phone":"+919990123456","price":"900","image_url":"https://cdn-icons-png.flaticon.com/512/4333/4333609.png","description":"Salon-quality services at home."},
        ]
        for d in demo:
            db.session.add(Provider(**d))
        db.session.commit()

# -------------------------
# Helpers
# -------------------------
def services_list():
    return [r[0] for r in db.session.query(Provider.service).distinct().all()]

# -------------------------
# Routes
# -------------------------
@app.route("/")
def home():
    q = request.args.get("q","").strip()
    location = request.args.get("location","").strip()
    service = request.args.get("service","").strip()
    query = Provider.query
    if q:
        pattern = f"%{q}%"
        query = query.filter((Provider.name.ilike(pattern)) | (Provider.description.ilike(pattern)) | (Provider.service.ilike(pattern)))
    if location:
        query = query.filter(Provider.location.ilike(f"%{location}%"))
    if service:
        query = query.filter(Provider.service.ilike(f"%{service}%"))
    providers = query.order_by(Provider.id.desc()).all()
    return render_template("index.html", providers=providers, services_list=services_list())

@app.route("/about")
def about():
    return render_template("about.html")

@app.route("/contact")
def contact_page():
    return render_template("contact.html")

@app.route("/provider/<int:prov_id>")
def provider_detail(prov_id):
    prov = Provider.query.get_or_404(prov_id)
    return render_template("provider_detail.html", provider=prov)

@app.route("/book/<int:prov_id>", methods=["POST"])
def book(prov_id):
    prov = Provider.query.get_or_404(prov_id)
    name = request.form.get("name","").strip()
    phone = request.form.get("phone","").strip()
    message = request.form.get("message","").strip()
    if not name or not phone:
        flash("Name and phone are required.")
        return redirect(url_for("provider_detail", prov_id=prov_id))
    b = Booking(name=name, phone=phone, message=message, provider_id=prov_id)
    db.session.add(b); db.session.commit()
    flash("Booking request saved â€” provider will contact you.")
    return redirect(url_for("provider_detail", prov_id=prov_id))

@app.route("/feedback", methods=["POST"])
def feedback():
    name = request.form.get("name","").strip()
    email = request.form.get("email","").strip()
    message = request.form.get("message","").strip()
    if not name or not email or not message:
        flash("Please fill all feedback fields.")
        return redirect(url_for("home"))
    fb = Feedback(name=name, email=email, message=message)
    db.session.add(fb); db.session.commit()
    flash("Thanks for your feedback â€” Rikip will see it.")
    return redirect(url_for("home"))

# -------------------------
# Admin
# -------------------------
ADMIN_USERNAME = "admin"
ADMIN_PASSWORD = "rikip123"

@app.route("/admin/login", methods=["GET","POST"])
def admin_login():
    if request.method == "POST":
        username = request.form.get("email","").strip()
        pw = request.form.get("password","").strip()
        if username == ADMIN_USERNAME and pw == ADMIN_PASSWORD:
            session["admin"] = True
            session["admin_email"] = username
            flash("Admin logged in.")
            return redirect(url_for("admin"))
        flash("Invalid credentials.")
    return render_template("admin_login.html")

@app.route("/admin")
def admin():
    if not session.get("admin"):
        return redirect(url_for("admin_login"))
    providers = Provider.query.order_by(Provider.id.desc()).all()
    bookings = Booking.query.order_by(Booking.created_at.desc()).all()
    feedbacks = Feedback.query.order_by(Feedback.created_at.desc()).all()
    return render_template("admin_panel.html", providers=providers, bookings=bookings, feedbacks=feedbacks)

@app.route("/admin/add", methods=["POST"])
def admin_add():
    if not session.get("admin"):
        return redirect(url_for("admin_login"))
    name = request.form.get("name","").strip()
    service = request.form.get("service","").strip()
    location = request.form.get("location","").strip()
    phone = request.form.get("phone","").strip()
    price = request.form.get("price","").strip() or "Negotiable"
    image_url = request.form.get("image_url","").strip() or "https://cdn-icons-png.flaticon.com/512/2099/2099058.png"
    desc = request.form.get("description","").strip() or f"Trusted {service} in {location}."
    if not name or not service or not location or not phone:
        flash("Please fill required fields.")
        return redirect(url_for("admin"))
    p = Provider(name=name, service=service, location=location, phone=phone, price=price, image_url=image_url, description=desc)
    db.session.add(p); db.session.commit()
    flash("Provider added.")
    return redirect(url_for("admin"))

@app.route("/admin/delete/<int:prov_id>")
def admin_delete(prov_id):
    if not session.get("admin"):
        return redirect(url_for("admin_login"))
    p = Provider.query.get_or_404(prov_id)
    db.session.delete(p); db.session.commit()
    flash("Provider removed.")
    return redirect(url_for("admin"))

@app.route("/admin/logout")
def admin_logout():
    session.pop("admin", None)
    session.pop("admin_email", None)
    flash("Admin logged out.")
    return redirect(url_for("home"))

# -------------------------
# Run
# -------------------------
if __name__ == "__main__":
    app.secret_key = os.environ.get('LC_SECRET','yourlocalservice-secret')
    app.run(host="0.0.0.0", port=5000, debug=False)
